#!/usr/bin/perl
use Fcntl qw(LOCK_EX LOCK_NB);
use File::NFSLock;

# Try to get an exclusive lock on myself.
my $lock = File::NFSLock->new($0, LOCK_EX|LOCK_NB);
die unless $lock;

use RRDs;
use File::HomeDir;

# define location of rrdtool databases
my $rrd = File::HomeDir->my_home . '/.rrd/db/memusage.rrd';
# define location of images
my $img = File::HomeDir->my_home . '/.rrd/img';

# Generate graphs
CreateGraphs("day");
CreateGraphs("week");
CreateGraphs("month");
CreateGraphs("year");

#------------------------------------------------------------------------------
sub CreateGraphs($){
  my $period = shift;
  
  RRDs::graph "$img/memusage-$period.png",
		"-s -1$period",
		"-t Memory Use",
		"-h", "150", "-w", "700",
		"-l 0",
		"-a", "PNG",
		"-v memory use",
		"--interlace",
		"--lazy",
		"DEF:usage=$rrd:memory_usage:AVERAGE",
		"VDEF:min=usage,MINIMUM",
		"VDEF:avg=usage,AVERAGE",
		"VDEF:max=usage,MAXIMUM",
		"VDEF:cur=usage,LAST",
		"COMMENT: \\l",
		"COMMENT:               ",
		"COMMENT:Minimum    ",
		"COMMENT:Maximum    ",
		"COMMENT:Average    ",
		"COMMENT:Current    \\l",
		"COMMENT:   ",
		"AREA:usage#EDA362:Usage  ",
		"LINE1:usage#F47200",
		"GPRINT:min:%5.1lf %sB   ",
		"GPRINT:max:%5.1lf %sB   ",
		"GPRINT:avg:%5.1lf %sB   ",
		"GPRINT:cur:%5.1lf %sB   \\l";
  if ($ERROR = RRDs::error) { 
    print "$0: unable to generate $period graph: $ERROR\n"; 
  }
}

exit 0;

data_error:
exit 1;

regex_error:
exit 2;
