#!/usr/bin/perl
use Fcntl qw(LOCK_EX LOCK_NB);
use File::NFSLock;

# Try to get an exclusive lock on myself.
my $lock = File::NFSLock->new($0, LOCK_EX|LOCK_NB);
die unless $lock;

use RRDs;
use LWP::UserAgent;
use File::stat;
use File::HomeDir;
use Time::localtime;

# define location of rrdtool databases
my $rrd = File::HomeDir->my_home . '/.rrd/db/nginx.rrd';
# define location of images
my $img = File::HomeDir->my_home . '/.rrd/img';
# define your nginx stats URL
my $URL = 'http://localhost/status';
# nginx pidfile -- used to detect when server is restarted
my $nginx_pidfile = '/var/run/nginx.pid';
# stores the most recent nginx pid -- used to detect when the server is restarted
my $nginx_last_pidfile = File::HomeDir->my_home . '/.rrd/nginx_last_pid';
# true if nginx has been restarted
my $nginx_has_been_restarted = 0;
# the time when the server was last restarted
my $server_restarted_time;

# Generate graphs
CreateGraphs("day");
CreateGraphs("week");
CreateGraphs("month");
CreateGraphs("year");

#------------------------------------------------------------------------------
sub CreateGraphs($){
  my $period = shift;
  
  RRDs::graph "$img/ngrequests-$period.png",
		"-s -1$period",
		"-t Requests on nginx",
		"-h", "150", "-w", "700",
		"-l 0",
		"-a", "PNG",
		"-v requests/min",
		"--interlace",
		"-X 0",
		"--lazy",
		"DEF:requests_persec=$rrd:requests:AVERAGE",
		"CDEF:requests=requests_persec,60,*",
		"LINE2:requests#336600:Requests",
		"GPRINT:requests:MAX:  Max\\: %5.1lf %S",
		"GPRINT:requests:AVERAGE: Avg\\: %5.1lf %S",
		"GPRINT:requests:LAST: Current\\: %5.1lf %S\\n",
		"HRULE:0#000000";
  if ($ERROR = RRDs::error) { 
    print "$0: unable to generate $period graph: $ERROR\n"; 
  }

  RRDs::graph "$img/ngconnections-$period.png",
		"-s -1$period",
		"-t Connections on nginx",
		"-h", "150", "-w", "700",
		"-l 0",
		"-a", "PNG",
		"-v connections",
		"--interlace",
		"-X 0",
		"--lazy",
		#"DEF:total_persec=$rrd:total:AVERAGE",
		#"DEF:reading_persec=$rrd:reading:AVERAGE",
		#"DEF:writing_persec=$rrd:writing:AVERAGE",
		#"DEF:waiting_persec=$rrd:waiting:AVERAGE",

		#"CDEF:total=total_persec,60,*",
		#"CDEF:reading=reading_persec,60,*",
		#"CDEF:writing=writing_persec,60,*",
		#"CDEF:waiting=waiting_persec,60,*",

		"DEF:total=$rrd:total:AVERAGE",
		"DEF:reading=$rrd:reading:AVERAGE",
		"DEF:writing=$rrd:writing:AVERAGE",
		"DEF:waiting=$rrd:waiting:AVERAGE",

		"LINE2:total#22FF22:Total",
		"GPRINT:total:LAST:   Current\\: %5.1lf %S",
		"GPRINT:total:MIN:  Min\\: %5.1lf %S",
		"GPRINT:total:AVERAGE: Avg\\: %5.1lf %S",
		"GPRINT:total:MAX:  Max\\: %5.1lf %S\\n",
		
		"LINE2:reading#0022FF:Reading",
		"GPRINT:reading:LAST: Current\\: %5.1lf %S",
		"GPRINT:reading:MIN:  Min\\: %5.1lf %S",
		"GPRINT:reading:AVERAGE: Avg\\: %5.1lf %S",
		"GPRINT:reading:MAX:  Max\\: %5.1lf %S\\n",
		
		"LINE2:writing#FF0000:Writing",
		"GPRINT:writing:LAST: Current\\: %5.1lf %S",
		"GPRINT:writing:MIN:  Min\\: %5.1lf %S",
		"GPRINT:writing:AVERAGE: Avg\\: %5.1lf %S",
		"GPRINT:writing:MAX:  Max\\: %5.1lf %S\\n",
		
		"LINE2:waiting#00AAAA:Waiting",
		"GPRINT:waiting:LAST: Current\\: %5.1lf %S",
		"GPRINT:waiting:MIN:  Min\\: %5.1lf %S",
		"GPRINT:waiting:AVERAGE: Avg\\: %5.1lf %S",
		"GPRINT:waiting:MAX:  Max\\: %5.1lf %S\\n",

		"HRULE:0#000000";
  if ($ERROR = RRDs::error) { 
    print "$0: unable to generate $period graph: $ERROR\n"; 
  }
}
